# ğŸ§  Phase 2: The Intelligent Engine - Implementation Guide

## Overview

Phase 2 transforms Soul Canvas from a visual note-taking tool into an **intelligent, self-organizing knowledge system**. The system now understands the semantic meaning of your thoughts and can automatically discover connections, answer questions, and provide reflective insights.

---

## ğŸ¯ Core Features Implemented

### 1. **Semantic Embeddings** (OpenAI)
- Converts all nodes into 1536-dimensional vectors using `text-embedding-3-small`
- Captures the **meaning** of content, not just keywords
- Works with text, images (via OCR), and Zotero notes

**How it works:**
```typescript
// Generate embedding for a node
const embedding = await generateNodeEmbedding(node, openaiKey);
// Returns: number[] (1536 dimensions)
```

### 2. **Semantic Gravitation** (Auto-Linking)
- Automatically creates synapses between semantically similar nodes
- Uses cosine similarity to measure relatedness (0-1 scale)
- Configurable threshold (default: 0.75 = 75% similarity)

**Example:**
- Node A: "Existential anxiety about freedom"
- Node B: "Fear of making wrong choices"
- System automatically links them (similarity: 0.82)

### 3. **Concept-Based Search**
- Search by **meaning**, not just words
- Query: "existential dread" â†’ Finds nodes about anxiety, mortality, meaning
- Returns top 10 most relevant results

### 4. **AI Reflection** (Claude)
- Analyzes your thought patterns
- Generates deep, reflective questions
- Example: *"I see you often write about 'Freedom' when you're in nature. What does freedom mean to you in those moments?"*

### 5. **Semantic Tagging** (Claude)
- Generates conceptual tags beyond keywords
- Example: Image of a sunset â†’ Tags: "transience", "beauty", "contemplation"

### 6. **Cluster Analysis** (Claude)
- Analyzes groups of related nodes
- Provides poetic insights about patterns
- Example: "These thoughts circle around the tension between belonging and autonomy..."

---

## ğŸ”§ Technical Architecture

### New Files Created

```
src/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ embeddings.ts      # OpenAI embedding generation & similarity
â”‚   â””â”€â”€ claude.ts           # Claude-based reflection & analysis
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useIntelligence.ts  # Main AI orchestration hook
â””â”€â”€ components/
    â””â”€â”€ AIPanel.tsx         # UI for all AI features
```

### Data Flow

```
1. User creates/edits node
   â†“
2. Generate embedding (OpenAI)
   â†“
3. Store embedding in node.embedding
   â†“
4. If auto-link enabled:
   - Calculate similarity with all other nodes
   - Create synapses for matches above threshold
   â†“
5. User can trigger:
   - Semantic search
   - Reflection
   - Cluster analysis
   - Semantic tagging
```

### Updated Types

```typescript
interface MindNode {
  // ... existing fields
  embedding?: number[];        // 1536-dim vector
  semanticTags?: string[];     // AI-generated tags
  lastEmbedded?: string;       // Timestamp
}

interface Synapse {
  // ... existing fields
  autoGenerated?: boolean;     // Created by AI
  similarity?: number;         // Semantic similarity score
}
```

---

## ğŸš€ Usage Guide

### Setup

1. **Get API Keys:**
   - OpenAI: https://platform.openai.com/api-keys
   - Claude: https://console.anthropic.com/
   - Gemini: https://makersuite.google.com/app/apikey (already have)

2. **Configure in App:**
   - Click âš™ï¸ Settings
   - Enter all three API keys
   - Enable "Auto-lÃ¤nkning" if desired
   - Set threshold (75% recommended)

### Workflow

#### Step 1: Generate Embeddings
```
1. Open AI Panel (ğŸ§  button or press 'I')
2. Click "Skapa Embeddings"
3. Wait for processing (shows progress)
4. All nodes now have semantic vectors
```

#### Step 2: Auto-Link Similar Nodes
```
1. In AI Panel, click "Hitta & LÃ¤nka Liknande"
2. System creates synapses between related thoughts
3. Physics engine pulls them together
4. Adjust threshold if too many/few links
```

#### Step 3: Semantic Search
```
1. In AI Panel, enter concept (e.g., "loneliness")
2. Click "SÃ¶k"
3. System finds semantically similar nodes
4. Results are automatically selected
```

#### Step 4: Get Reflections
```
1. Select nodes (or leave empty for all)
2. Click "Reflektera Ã¶ver X valda"
3. Claude analyzes patterns
4. Receive a deep question to contemplate
```

#### Step 5: Generate Semantic Tags
```
1. Select nodes
2. Click "Tagga X valda"
3. Claude generates conceptual tags
4. Tags appear on nodes
```

---

## ğŸ¨ UI Features

### AI Panel (Press 'I')
- **Status Bar**: Shows embedding progress
- **6 Main Actions**:
  1. ğŸ“Š Create Embeddings
  2. ğŸ”— Auto-Link Similar
  3. ğŸ” Semantic Search
  4. ğŸ·ï¸ Generate Tags
  5. ğŸ’­ AI Reflection
  6. ğŸŒŒ Cluster Analysis

### Visual Indicators
- **Auto-generated links**: Marked in synapse data
- **Embedded nodes**: Tracked in status bar
- **Processing**: Animated progress indicator

### Keyboard Shortcuts
- `I` - Toggle AI Panel
- `Esc` - Close AI Panel
- (All existing shortcuts still work)

---

## ğŸ’¡ Best Practices

### When to Generate Embeddings
- After adding multiple new nodes
- Before using semantic search
- When you want auto-linking

### Threshold Settings
- **0.85-0.95**: Very strict (only obvious connections)
- **0.75-0.85**: Balanced (recommended)
- **0.50-0.75**: Loose (discovers subtle patterns)

### Reflection Tips
- Select 5-10 related nodes for focused questions
- Leave empty for broad life patterns
- Use after journaling sessions

### Search Tips
- Use concepts, not keywords: "mortality" not "death"
- Try emotions: "anxiety", "joy", "confusion"
- Abstract ideas work best: "freedom", "belonging"

---

## ğŸ”¬ Technical Details

### Embedding Model
- **Model**: `text-embedding-3-small`
- **Dimensions**: 1536
- **Cost**: ~$0.02 per 1M tokens
- **Speed**: ~100 nodes/minute

### Similarity Calculation
```typescript
// Cosine similarity formula
similarity = (A Â· B) / (||A|| Ã— ||B||)

// Returns: 0.0 (completely different) to 1.0 (identical)
```

### Claude Models
- **Reflection**: `claude-3-5-sonnet-20241022`
- **Tags**: `claude-3-5-sonnet-20241022`
- **Analysis**: `claude-3-5-sonnet-20241022`

### Performance
- **Embedding**: ~1 second per node
- **Search**: Instant (after embeddings exist)
- **Auto-link**: ~2 seconds for 100 nodes
- **Reflection**: ~3-5 seconds

---

## ğŸ› Troubleshooting

### "OpenAI API key saknas"
- Go to Settings (âš™ï¸)
- Enter your OpenAI API key
- Key is stored in localStorage

### "Bilden saknar text (kÃ¶r OCR fÃ¶rst)"
- Right-click image â†’ "AI: LÃ¤s text"
- Wait for OCR to complete
- Then generate embedding

### No Links Created
- Lower the threshold in Settings
- Ensure nodes have embeddings
- Check that nodes have meaningful content

### Slow Performance
- Embeddings are cached (only generated once)
- Batch operations show progress
- Consider processing in smaller batches

---

## ğŸ“Š Cost Estimates

### OpenAI (Embeddings)
- 100 nodes: ~$0.01
- 1,000 nodes: ~$0.10
- 10,000 nodes: ~$1.00

### Claude (Reflection/Tags)
- Per reflection: ~$0.01
- Per tag generation: ~$0.005
- Per cluster analysis: ~$0.01

**Total for typical usage**: $1-5/month

---

## ğŸ”® Future Enhancements (Phase 3+)

- [ ] Local embeddings (transformers.js) - no API needed
- [ ] Time-based clustering (old thoughts fade)
- [ ] Automatic journal prompts
- [ ] Export semantic graph as visualization
- [ ] Multi-language support
- [ ] Voice input with semantic understanding

---

## ğŸ“ Philosophy

Phase 2 realizes the vision of **Semantic Gravitation**: thoughts that belong together find each other naturally, not through manual organization but through understanding of meaning.

The system becomes a **Zen Master** - asking questions, revealing patterns, and helping you see connections you didn't know existed.

---

## ğŸ“ Example Session

```
1. Create 20 journal entries over a week
2. Generate embeddings (20 seconds)
3. Enable auto-linking
4. Watch thoughts cluster by theme
5. Search "anxiety" â†’ Find all related thoughts
6. Select anxiety cluster â†’ Get reflection
7. Claude asks: "What are you really afraid of losing?"
8. Create new node with answer
9. System auto-links to freedom cluster
10. Discover: anxiety â†” freedom connection
```

---

## ğŸ™ Credits

- **OpenAI**: Semantic embeddings
- **Anthropic**: Reflective AI
- **Google**: OCR & image analysis
- **You**: The consciousness that makes it all meaningful

---

**Phase 2 Status**: âœ… Complete and Ready to Use

Press `I` to open the AI Panel and start exploring your mind! ğŸ§ âœ¨